# This suite of tests is in the form of <arrayformula> <offsetrow> <offsetcol> <resultingformula>

# The default case is to map each cell in the area into the formula in turn as an array
[:arithmetic, [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:operator, "*"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:arithmetic, [:cell, "A1"], [:operator, "*"], [:cell, "B1"]]], [:row, [:arithmetic, [:cell, "A2"], [:operator, "*"], [:cell, "B2"]]]]

[:comparison, [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:operator, ">="], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:comparison, [:cell, "A1"], [:operator, ">="], [:cell, "B1"]]], [:row, [:comparison, [:cell, "A2"], [:operator, ">="], [:cell, "B2"]]]]
[:comparison, [:array, [:row, [:cell, "B3"]], [:row, [:cell, "B4"]], [:row, [:cell, "B5"]]], [:comparator, "="], [:number, "8"]]	 [:array, [:row, [:comparison, [:cell, "B3"], [:comparator, "="], [:number, "8"]]], [:row, [:comparison, [:cell, "B4"], [:comparator, "="], [:number, "8"]]], [:row, [:comparison, [:cell, "B5"], [:comparator, "="], [:number, "8"]]]] 

[:string_join, [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:string_join, [:cell, "A1"], [:cell, "B1"]]], [:row, [:string_join, [:cell, "A2"], [:cell, "B2"]]]]

# If a function takes no arguments, then leave it be
[:function, "PI"]	[:function, "PI"]

# If a function accepts arrays as arguments, then leave the argument be
[:function, "AVERAGE", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:function, "AVERAGE", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]
[:function, "COUNT", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:function, "COUNT", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]
[:function, "COUNTA", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:function, "COUNTA", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]
[:function, "MAX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:function, "MAX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]
[:function, "MIN", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:function, "MIN", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]
[:function, "SUM", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:function, "SUM", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]
[:function, "SUMPRODUCT", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:function, "SUMPRODUCT", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]

# If the function doesn't accept an array as argument, then map the function to an array
[:function, "ABS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:array, [:row, [:function, "ABS", [:cell, "A1"]]], [:row, [:function, "ABS", [:cell, "A2"]]]]
[:function, "CHOOSE", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "CHOOSE", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "CHOOSE", [:cell, "A2"], [:cell, "B2"]]]]
[:function, "COSH", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:array, [:row, [:function, "COSH", [:cell, "A1"]]], [:row, [:function, "COSH", [:cell, "A2"]]]]
[:function, "FIND", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "FIND", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "FIND", [:cell, "A2"], [:cell, "B2"]]]]
[:function, "IF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "IF", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "IF", [:cell, "A2"], [:cell, "B2"]]]]
[:function, "IFERROR", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "IFERROR", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "IFERROR", [:cell, "A2"], [:cell, "B2"]]]]
[:function, "LEFT", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "LEFT", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "LEFT", [:cell, "A2"], [:cell, "B2"]]]]
[:function, "MOD", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "MOD", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "MOD", [:cell, "A2"], [:cell, "B2"]]]]
[:function, "PMT", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]],  [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "PMT", [:cell, "A1"], [:cell, "B1"], [:cell, "C1"]]], [:row, [:function, "PMT", [:cell, "A2"], [:cell, "B2"], [:cell, "C2"]]]]
[:function, "ROUND", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "ROUND", [:cell, "A1"], [:cell, "B1"]]], [:row, [:function, "ROUND", [:cell, "A2"], [:cell, "B2"]]]]

# If the function accepts a mixture of arrays and non arrays, then intelligently map the function to an array
# INDEX(array,not_array,[not_array])
[:function, "INDEX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "INDEX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B1"]]], [:row, [:function, "INDEX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B2"]]]]
[:function, "INDEX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "INDEX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B1"], [:cell, "C1"]]], [:row, [:function, "INDEX", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B2"], [:cell, "C2"]]]]

# MATCH(not_array,array,[not_array])
[:function, "MATCH", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "MATCH", [:cell, "A1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]], [:row, [:function, "MATCH", [:cell, "A2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]]]
[:function, "MATCH", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "MATCH", [:cell, "A1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"]]], [:row, [:function, "MATCH", [:cell, "A2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"]]]]
[:function, "MATCH", [:cell, "$E$9"], [:array, [:row, [:cell, "F25"], [:cell, "G25"], [:cell, "H25"]]], [:number, "0"]]	[:function, "MATCH", [:cell, "$E$9"], [:array, [:row, [:cell, "F25"], [:cell, "G25"], [:cell, "H25"]]], [:number, "0"]]

# SUBTOTAL(not_array,*arrays)
[:function, "SUBTOTAL", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "SUBTOTAL", [:cell, "A1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]], [:row, [:function, "SUBTOTAL", [:cell, "A2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]]]
[:function, "SUBTOTAL", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "SUBTOTAL", [:cell, "A1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]], [:row, [:function, "SUBTOTAL", [:cell, "A2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]]]

# SUMIF(array,not_array,[array])
[:function, "SUMIF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]]	[:array, [:row, [:function, "SUMIF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B1"]]], [:row, [:function, "SUMIF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B2"]]]]
[:function, "SUMIF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "SUMIF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B1"], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]], [:row, [:function, "SUMIF", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:cell, "B2"], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]]]

# SUMIFS(array,array,not_array,[array,not_array...])
[:function, "SUMIFS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "SUMIFS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"]]], [:row, [:function, "SUMIFS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"]]]]
[:function, "SUMIFS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "SUMIFS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"]]], [:row, [:function, "SUMIFS", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"]]]]

# VLOOKUP(not_array,array,not_array,[not_array])
[:function, "VLOOKUP", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]	[:array, [:row, [:function, "VLOOKUP", [:cell, "A1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"]]], [:row, [:function, "VLOOKUP", [:cell, "A2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"]]]]
[:function, "VLOOKUP", [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]], [:array, [:row, [:cell, "D1"]], [:row, [:cell, "D2"]]]]	[:array, [:row, [:function, "VLOOKUP", [:cell, "A1"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"], [:cell, "D1"]]], [:row, [:function, "VLOOKUP", [:cell, "A2"], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"], [:cell, "D2"]]]]

# Should cope with nesting
[:function, "IF", [:comparison, [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:operator, ">="], [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]]],  [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]]]	[:array, [:row, [:function, "IF", [:comparison, [:cell, "A1"], [:operator, ">="], [:cell, "B1"]], [:cell, "A1"]]], [:row, [:function, "IF", [:comparison, [:cell, "A2"], [:operator, ">="], [:cell, "B2"]], [:cell, "A2"]]]]
[:function, "IF", [:comparison, [:array, [:row, [:cell, "B3"]], [:row, [:cell, "B4"]], [:row, [:cell, "B5"]]], [:comparator, "="], [:number, "8"]], [:string, "Eight"], [:string, "Not Eight"]]	[:array, [:row, [:function, "IF", [:comparison, [:cell, "B3"], [:comparator, "="], [:number, "8"]], [:string, "Eight"], [:string, "Not Eight"]]], [:row, [:function, "IF", [:comparison, [:cell, "B4"], [:comparator, "="], [:number, "8"]], [:string, "Eight"], [:string, "Not Eight"]]], [:row, [:function, "IF", [:comparison, [:cell, "B5"], [:comparator, "="], [:number, "8"]], [:string, "Eight"], [:string, "Not Eight"]]]]
[:arithmetic, [:array, [:row, [:cell, "A1"]], [:row, [:cell, "A2"]]], [:operator, "*"], [:function, "INDEX", [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:array, [:row, [:cell, "C1"]], [:row, [:cell, "C2"]]]]]	[:array, [:row, [:arithmetic, [:cell, "A1"], [:operator, "*"], [:function, "INDEX", [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C1"]]]], [:row, [:arithmetic, [:cell, "A2"], [:operator, "*"], [:function, "INDEX", [:array, [:row, [:cell, "B1"]], [:row, [:cell, "B2"]]], [:cell, "C2"]]]]]

# test case
[:function, "INDEX", [:array, [:row, [:cell, "F26"], [:cell, "G26"], [:cell, "H26"]], [:row, [:cell, "F27"], [:cell, "G27"], [:cell, "H27"]], [:row, [:cell, "F28"], [:cell, "G28"], [:cell, "H28"]], [:row, [:cell, "F29"], [:cell, "G29"], [:cell, "H29"]]], [:null], [:function, "MATCH", [:cell, "$E$9"], [:array, [:row, [:cell, "F25"], [:cell, "G25"], [:cell, "H25"]]], [:number, "0"]]]	[:function, "INDEX", [:array, [:row, [:cell, "F26"], [:cell, "G26"], [:cell, "H26"]], [:row, [:cell, "F27"], [:cell, "G27"], [:cell, "H27"]], [:row, [:cell, "F28"], [:cell, "G28"], [:cell, "H28"]], [:row, [:cell, "F29"], [:cell, "G29"], [:cell, "H29"]]], [:null], [:function, "MATCH", [:cell, "$E$9"], [:array, [:row, [:cell, "F25"], [:cell, "G25"], [:cell, "H25"]]], [:number, "0"]]]

# Awkwardly uneven array shapes
[:arithmetic, [:array, [:row, [:cell, :C3], [:cell, :D3]], [:row, [:cell, :C4], [:cell, :D4]], [:row, [:cell, :C5], [:cell, :D5]]], [:operator, :*], [:array, [:row, [:cell, :B6]], [:row, [:cell, :B7]]]]	[:array, [:row, [:arithmetic, [:cell, :C3], [:operator, :*], [:cell, :B6]], [:arithmetic, [:cell, :D3], [:operator, :*], [:cell, :B6]]], [:row, [:arithmetic, [:cell, :C4], [:operator, :*], [:cell, :B7]], [:arithmetic, [:cell, :D4], [:operator, :*], [:cell, :B7]]], [:row, [:arithmetic, [:cell, :C5], [:operator, :*], [:error, :"#N/A"]], [:arithmetic, [:cell, :D5], [:operator, :*], [:error, :"#N/A"]]]]
